C─────────────────────────────────────────────────────────────────────────────┐
C                            IiI FORTRAN Program            01/12/92 03:00pm  │
C        Name: Analog_XY                                                      │
C                                                                             │
C Description: Индуктивный алгоритм Комплексирования Аналогов                 │
C              Метода Группового Учета Аргументов   (МГУА)                    │
C              для прогноза и распознавания событий (ситуаций)                │
C                                                                             │
C Copyright (C) Nataly and Gregory Ivakhnenko, 1990-1991. All Rights Reserved │
C─────────────────────────────────────────────────────────────────────────────┘

      program  Analog_XY
      real
     +Y   [allocatable] (:,:), YP  [allocatable] (:,:),
     +XV  [allocatable] (:,:), X   [allocatable] (:,:),
     +XA  [allocatable] (:,:), XB  [allocatable] (:,:),
     +CL  [allocatable] (:,:), RAS [allocatable] (:,:),
     +RIY [allocatable] (:),   RAY [allocatable] (:),
     +SY  [allocatable] (:),   OC  [allocatable] (:),
     +CVJ [allocatable] (:),   CLX [allocatable] (:),
     +RSX [allocatable] (:),   XPR [allocatable] (:),
     +V   [allocatable] (:),   XN  [allocatable] (:)
      integer
     +IVM [allocatable] (:,:), IL [allocatable] (:),
     +IMX [allocatable] (:),   IN [allocatable] (:),
     +IPAR (3), KL

      logical*1    LA [allocatable] (:)
      character*80 D,G
      character*65 D_NAME

      common /LDAT/  JPRI
      common /LNORXX/JPRN
      common /LRAST/ JRAS
      common /LRAXV/ JRAXV
      common /LMAIN/ JP,JFM
      automatic
C==============================================================================
C       MM           - максимальное количество переменных
C       MMY          - максимальное количество функций
C       NN           - максимальное количество точек
C       XV  (MM,NN1) - исходный массив аргументов
C       X   (MM,NN1) - массив аргументов для текущего ансамбля переменных
C       Y   (MMY,NN) - исходный массив функций
C       YP  (MMY,NN1)- массив прогнозов функций
C       XA  (MM,NN)  - массив обобщенных аналогов
C       XB  (MM,NN)  - массив действительных значений аргументов
C       CL  (JJFR,NN)- массив весовых коеффициентов аналогов
C       RAS (NN,NN)  - массив расстояний для функций
C       RSX (MM)     - вектор минимальных значений аргументов
C       CLX (MM)     - вектор максимальных значений аргументов
C       RIY (MMY)    - вектор минимальных значений функций
C       RAY (MMY)    - вектор максимальных значений функций
C       SY  (MMY)    - вектор средних значений функций
C       OC  (MMY)    - вектор оценок прогнозов функций
C       CVJ (MM)     - вектор критериев прогноза аргументов
C       XPR (MM)     - текущий вектор аргументов для прогноза
C       V   (NN)     - вектор обратных расстояний от текущего вектора аргументов
C       XN  (NN)     - вспомогательный вектор расстояний
C       IVM (JJFR,NN)- массив ближайших соседей-аналогов
C       IL  (MM)     - вектор обратных расстояний от текущего
C       IMX (MM)     - вспомогательный вектор ансамбля переменных
C       IN  (NN)     - вектор номеров точек для ранжирования по расстоянию
C       IPAR(LL)     - вектор параметров из файла PARA
C       LA  (MM)     - вектор ансамбля переменных
C       JJFR [=10]   - максимальное количество аналогов
C       JFM          - количество аналогов
C       JFC          - оптимальное количество аналогов
C       JMC          - оптимальное количество переменных
C       JPRI         - флаг печати исходных данных (равен 0 или 1)
C       JPRN         - флаг печати нормированных массивов исходных данных
C       JRAS         - флаг печати расстояний для функций
C       JRAXV        - флаг печати расстояний для аргументов
C       JP           - флаг печати промежуточных результатов
C==============================================================================
      JJFR=10
      write (*,1111)
      write (*,999)
      write (*,2222)
C --------------------------------------------------------------------------
C           Ввод параметров из файла PARA
C --------------------------------------------------------------------------
      call DI_PARA (JJFR,IPAR)
C --------------------------------------------------------------------------
C           Ввод данных
C --------------------------------------------------------------------------
      write (*,'(/,14X,2A\)') 'Ввести данные из  файла ',
     +' DATAY ?  (Y/N) -> '
       read (*,'(A)') Q
      write (*,*)
C --------------------------------------------------------------------------
C           Ввод данных из файла DATAY
C --------------------------------------------------------------------------
      if(Q.ne.'N'.and.Q.ne.'n') then
         open (unit=1,file='DATAY',status='OLD',mode='READ',err=99999)
            read (1,'(3X,A,/)') D
            read (1,'(A3,I3)') G,M
            read (1,'(A3,I3,/)') G,N
            if(M.le.0.or.N.le.1) then
               close (unit=1)
               write (*,444) M,N
               stop ' '
            endif

            allocate ( XV(M,N+1), XPR(M), IL(M), stat=MEMERR )
            if(MEMERR.ne.0)  stop ' Abort: Not enough storage!'
               do 30 I=1,N
30             read (1,*) J,(XV(J,I),J=1,M)
            read (1,'(3X,A)') G
            read (1,'(A4,I2)') G,MY
         close (unit=1)
         if(MY.le.0) then
            write (*,666) MY
            deallocate ( XV,XPR,IL, stat=IERR )
            if(IERR.ne.0) write (*,*) ' Warning: Deallocation error!'
            stop ' '
         endif

         allocate ( Y(MY,N), stat=MEMERR )
         if(MEMERR.ne.0)  stop ' Abort: Not enough storage!'
         MM=M
         MMY=MY
         NN=N
         NN1=N+1
         call DATINY (M,MY,N,MMY,MM,NN,NN1,XV,XPR,Y,IL)
      else
C --------------------------------------------------------------------------
C           Ввод данных в режиме диалога c клавиатуры в файл DATAY
C --------------------------------------------------------------------------
         call D1_DATAY (KL,D_NAME,M,MY,N)
         MM=M
         MMY=MY
         NN=N
         NN1=N+1
            allocate (XV(MM,NN1),XPR(MM),IL(MM),Y(MMY,NN),stat=MEMERR)
            if(MEMERR.ne.0) stop ' Abort: Not enough storage!'
         call D2_DATAY (KL,D_NAME,M,MY,N,MM,MMY,NN,NN1,Y,XV,XPR,IL)
      endif
C --------------------------------------------------------------------------
C           Распределение памяти под остальные массивы и вектора
C --------------------------------------------------------------------------
      allocate ( YP(MMY,NN1), X(MM,NN1), XA(MM,NN), XB(MM,NN),
     +           CL(JJFR,NN), RAS(NN,NN), RIY(MMY), RAY(MMY), SY(MMY),
     +           OC(MMY), CVJ(MM), CLX(MM), RSX(MM), V(NN), XN(NN),
     +           IVM(JJFR,NN), IMX(MM), IN(NN), LA(MM),
     +           stat=MEMERR )
      if(MEMERR.ne.0)  stop ' Abort: Not enough storage!'
C --------------------------------------------------------------------------
C        Присвоение значений идентификаторам и параметрам
C --------------------------------------------------------------------------
      if(JFM.ge.N)  then
         write (*,777) JFM,N,N-1
         JFM=N-1
      endif
      JPRN  = JP
      JRAS  = 0
      JRAXV = 0
      write (*,111) JPRI
      write (*,222) JP
      write (*,333) JFM
      write (*,888)
      read (*,*)
      I=M*N
      if(JP.eq.0.and.I.gt.40) write (*,'(13X,A,//)')
     +'Подождите, пожалуйста ...'
C --------------------------------------------------------------------------
C        Вызов основного модуля
C --------------------------------------------------------------------------
      call PATXYY (MY,M,N,JJFR,MMY,MM,NN,NN1,
     +Y,YP,XV,X,XA,XB,CL,RAS,RIY,RAY,SY,OC,CVJ,CLX,RSX,XPR,
     +V,XN,IVM,IL,IMX,IN,LA)
C --------------------------------------------------------------------------
C        Освобождение памяти
C --------------------------------------------------------------------------
      read (*,*)
      deallocate (Y,YP,XV,X,XA,XB,CL,RAS,RIY,RAY,SY,OC,CVJ,CLX,RSX,
     +            XPR,V,XN,IVM,IL,IMX,IN,LA, stat=IERR )
      if(IERR.ne.0) write (*,*) ' Warning: Deallocation error!'
      stop ' '

111   format (/,7X,'Параметры режима работы алгоритма :',/,
     +13X,'Идентификатор печати исходных данных',11X,
     +'JPRI = ',I2)
222   format (13X,'Идентификатор печати промежуточных',
     +' результатов   JP = ',I2,)
333   format (13X,'Максимальное количество аналогов',16X,'JFM =',I3)
444   format (/,8X,'Ошибка: Количество переменных исходного ',
     +'массива M =',I2,/,16X,'или точек N =',I2,' мало для прогноза ',
     +'( M > 0, N > 1 ) !',/)
666   format (/,8X,'Ошибка: Количество функций MY =',I2,
     +' мало для прогноза  ( MY > 0 ) !',/)
777   format (/,8X,'Предуреждение: количество аналогов JFM =',I3,
     +' превышает',/,15X,'количество точек N =',I3,
     +' !  Принимается JFM =',I3,'.'/)
888   format (/,1X,79('═'),/)
999   format(4X,'║',69X,'║',
     +/,4X,'║',16X,'АЛГОРИТМ  КОМПЛЕКСИРОВАНИЯ  АНАЛОГОВ',17X,'║',
     +/,4X,'║',5X,'Метода  Группового  Учета  Аргументов  (МГУА)',
     +'  для  прогноза',4X,'║',
     +/,4X,'║',22X,'и  распознавания  событий',22X,'║',
     +/,4X,'║',69X,'║',
     +/,4X,'║',5X,'Версия 2.16   Наталья и Григорий Ивахненко (c)',
     +'  Киев 1990-92',4X,'║')
1111  format (///,4X,'╔═════════════════════════════════════════════',
     +'════════════════════════╗')
2222  format (4X,'╚═════════════════════════════════════════════',
     +'════════════════════════╝')
99999 stop '*** Ошибка: Невозможно открыть файл DATAY ***'
      end
